name: Vinted Platform Monitor

on:
  # Run every day at 8 AM UTC (9 AM Paris time in winter, 10 AM in summer)
  schedule:
    - cron: '0 8 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Run on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - 'backend/monitoring/**'
      - '.github/workflows/vinted-monitor.yml'

jobs:
  monitor:
    name: Monitor Vinted Platform
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: Run monitoring tests
        env:
          VINTED_COOKIE: ${{ secrets.VINTED_COOKIE }}
          VINTED_USER_AGENT: ${{ secrets.VINTED_USER_AGENT }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python backend/monitoring/run_monitor.py

      - name: Upload monitoring results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-results-${{ github.run_number }}
          path: backend/monitoring/snapshots/monitor_results_latest.json
          retention-days: 30

      - name: Upload snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-snapshots-${{ github.run_number }}
          path: backend/monitoring/snapshots/
          retention-days: 7

      # Optional: Create an issue if monitoring fails
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const resultsPath = 'backend/monitoring/snapshots/monitor_results_latest.json';

            let resultsContent = 'âš ï¸ Monitoring results not available';
            try {
              if (fs.existsSync(resultsPath)) {
                const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
                resultsContent = `
            ## Monitoring Status: ${results.status?.toUpperCase() || 'UNKNOWN'}

            **Timestamp:** ${results.timestamp || 'N/A'}

            ### Changes Detected
            ${results.changes_detected?.map(c => `- [${c.severity?.toUpperCase()}] ${c.message}`).join('\n') || 'None'}

            ### Failed Tests
            ${results.tests?.filter(t => t.status === 'failed').map(t => `- ${t.name}: ${t.error || t.message || 'Unknown error'}`).join('\n') || 'None'}
            `;
              }
            } catch (e) {
              resultsContent += `\n\nError reading results: ${e.message}`;
            }

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Vinted Platform Monitoring Alert',
              body: `
            # Vinted Platform Monitoring Alert

            The automated monitoring detected changes or issues with the Vinted platform.

            ${resultsContent}

            **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            ## Action Required
            1. Check the monitoring results artifact
            2. Review the changes detected
            3. Update selectors if necessary
            4. Test the bot manually
            `,
              labels: ['monitoring', 'urgent']
            });
