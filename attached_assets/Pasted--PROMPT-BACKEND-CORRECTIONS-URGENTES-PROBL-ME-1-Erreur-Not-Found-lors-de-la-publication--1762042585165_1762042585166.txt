üîß PROMPT BACKEND - CORRECTIONS URGENTES
‚ùå PROBL√àME 1 : Erreur "Not Found" lors de la publication
Sympt√¥me : POST /bulk/drafts/{draft_id}/publish retourne {"ok": false, "status": "prepare_failed", "reason": "Not Found"}

Cause probable : Incoh√©rence dans les chemins des photos entre g√©n√©ration et publication.

Dans le r√©seau, je vois :

Draft photos : "/temp_photos/dc4d13b1/photo_000.jpg"
Analysis result : "backend/data/temp_photos/dc4d13b1/photo_000.jpg"
FIX REQUIS :


# Dans /bulk/drafts/{draft_id}/publish
# 1. Ajouter des logs d√©taill√©s
print(f"[PUBLISH] Draft ID: {draft_id}")
print(f"[PUBLISH] Photos paths: {draft['photos']}")

# 2. V√©rifier l'existence des photos
for photo_path in draft['photos']:
    # Essayer plusieurs chemins possibles
    paths_to_try = [
        photo_path,
        f"backend/data{photo_path}",
        photo_path.replace("/temp_photos/", "backend/data/temp_photos/")
    ]
    
    for path in paths_to_try:
        if os.path.exists(path):
            print(f"[PUBLISH] ‚úÖ Photo trouv√©e : {path}")
            break
    else:
        return {"ok": False, "reason": f"Photo introuvable : {photo_path}", "status": "prepare_failed"}

# 3. V√©rifier la session Vinted
if not vinted_session or not vinted_session.get("cookie"):
    return {"ok": False, "reason": "Session Vinted expir√©e ou manquante", "status": "prepare_failed"}
‚ùå PROBL√àME 2 : Tailles incorrectes (ex: "L" au lieu de "XS")
Sympt√¥me : Le jogging Burberry est taille "16Y / 165 cm (‚âà XS)" dans le brouillon, mais s'affiche comme "L" apr√®s publication.

CAUSES POSSIBLES :

L'IA g√©n√®re "16Y / 165 cm (‚âà XS)" au lieu de juste "XS"
Lors de la publication, la taille est mal mapp√©e vers les cat√©gories Vinted
FIX REQUIS :


# Dans le SYSTEM_PROMPT de l'IA (g√©n√©ration de brouillons)
# MODIFIER LA SECTION "SIZE NORMALIZATION"

"""
### SIZE NORMALIZATION (CRITIQUE)
- Retourner UNIQUEMENT la taille adulte normalis√©e (XS/S/M/L/XL/XXL)
- NE JAMAIS inclure la taille enfant dans le champ 'size'
- Exemples:
  ‚ùå "16Y / 165 cm (‚âà XS)"  ‚Üí MAUVAIS
  ‚úÖ "XS"                    ‚Üí BON
  ‚ùå "12 ans (‚âà S)"          ‚Üí MAUVAIS
  ‚úÖ "S"                     ‚Üí BON

- Mettre les d√©tails dans 'size_details' (champ s√©par√©) :
  {
    "size": "XS",
    "size_details": "Taille d'origine 16Y / 165 cm, √©quivaut √† XS adulte"
  }
"""

# Dans /bulk/generate (apr√®s appel OpenAI)
for item in items:
    # Nettoyer la taille
    size = item.get("size", "")
    if "‚âà" in size or "/" in size or "ans" in size.lower():
        # Extraire juste la taille finale
        import re
        match = re.search(r'[X]{0,2}[SMLX]{1,2}', size.upper())
        if match:
            item["size"] = match.group(0)
            item["size_details"] = size  # Garder l'info compl√®te ailleurs
        else:
            item["size"] = "M"  # Fallback
            item["size_details"] = size
‚ùå PROBL√àME 3 : Titres trop complexes
Sympt√¥me : "Jogging Burberry noir 16Y / 165 cm (‚âà XS) ‚Äì bon √©tat" au lieu de "Jogging Burberry noir XS ‚Äì bon √©tat"

FIX REQUIS :


# Dans le SYSTEM_PROMPT de l'IA
"""
### TITLE GENERATION (SIMPLIFI√â)
Format : "[Type] [Marque] [Couleur] [Taille] ‚Äì [√©tat]"

Exemples :
‚úÖ "Jogging Burberry noir XS ‚Äì bon √©tat"
‚úÖ "Hoodie Karl Lagerfeld noir et blanc L ‚Äì tr√®s bon √©tat"

‚ùå NE JAMAIS inclure :
- Tailles enfant (16Y, 165 cm)
- Mesures (cm, pouces)
- Parenth√®ses avec √©quivalences
"""
‚ùå PROBL√àME 4 : Condition (√©tat) vide dans les brouillons
Sympt√¥me : Le champ "condition" n'est jamais rempli dans le Select.

CAUSE : Le backend retourne "condition": "Bon √©tat" mais le frontend attendait "good".

‚úÖ D√âJ√Ä CORRIG√â C√îT√â FRONTEND - Le Select accepte maintenant les valeurs fran√ßaises directes.

V√âRIFICATION BACKEND :


# S'assurer que le backend retourne bien les valeurs fran√ßaises
ALLOWED_CONDITIONS = [
    "Neuf avec √©tiquette",
    "Tr√®s bon √©tat",
    "Bon √©tat",
    "√âtat satisfaisant"
]

# Dans /bulk/generate, normaliser
condition = item.get("condition", "")
if condition.lower() not in [c.lower() for c in ALLOWED_CONDITIONS]:
    # Mapper les valeurs anglaises vers fran√ßais si n√©cessaire
    mapping = {
        "new with tags": "Neuf avec √©tiquette",
        "very good": "Tr√®s bon √©tat",
        "good": "Bon √©tat",
        "satisfactory": "√âtat satisfaisant"
    }
    item["condition"] = mapping.get(condition.lower(), "Bon √©tat")
‚ú® NOUVELLE FONCTIONNALIT√â : Upload de photos additionnelles
Endpoint √† cr√©er :


@router.post("/bulk/drafts/{draft_id}/photos")
async def add_photos_to_draft(draft_id: str, files: List[UploadFile]):
    """Ajouter des photos √† un brouillon existant"""
    
    # 1. Charger le brouillon
    draft = load_draft(draft_id)
    if not draft:
        return {"ok": False, "reason": "Draft not found"}
    
    # 2. Upload des nouvelles photos
    new_photos = []
    for file in files:
        photo_path = f"/temp_photos/{draft_id}/{len(draft['photos']) + len(new_photos)}.jpg"
        save_path = f"backend/data{photo_path}"
        
        # Sauvegarder
        os.makedirs(os.path.dirname(save_path), exist_ok=True)
        with open(save_path, "wb") as f:
            f.write(await file.read())
        
        new_photos.append(photo_path)
    
    # 3. Mettre √† jour le brouillon
    draft["photos"].extend(new_photos)
    save_draft(draft_id, draft)
    
    return {"ok": True, "added": len(new_photos), "total": len(draft["photos"])}
‚úÖ TESTS DE VALIDATION
Apr√®s corrections, tester :


# 1. G√©n√©rer des brouillons
curl -X POST http://localhost:5000/bulk/generate \
  -H "Authorization: Bearer {TOKEN}" \
  -d '{"plan_id": "test123", "style": "streetwear"}'

# 2. V√©rifier qu'un brouillon contient :
# - condition: "Bon √©tat" (fran√ßais)
# - size: "XS" (pas "16Y / 165 cm (‚âà XS)")
# - title: "Jogging Burberry noir XS ‚Äì bon √©tat" (simple)
# - photos: ["/temp_photos/..."] (chemins coh√©rents)

# 3. Publier
curl -X POST http://localhost:5000/bulk/drafts/{draft_id}/publish \
  -H "Authorization: Bearer {TOKEN}"

# Doit retourner : {"ok": true, "vinted_url": "..."}