Contexte √† respecter

Backend FastAPI (Py 3.11) sur Replit (Uvicorn 0.0.0.0:5000).

D√©j√† en place : routes sant√©, upload simple, /vinted/auth/session, /vinted/auth/check, /vinted/photos/upload, /vinted/listings/prepare, /vinted/listings/publish (2 phases, dry_run par d√©faut).

Session Vinted stock√©e chiffr√©e (Fernet). CORS d√©j√† OK.

On veut maintenant un pipeline bulk : j‚Äôupload ~147 photos (voire +), le backend :

ing√®re (multi-fichiers ou ZIP),

d√©duplique (m√™mes photos/s√©ries) et reconna√Æt le type de v√™tement (+ couleur dominante),

groupe les photos par article (un v√™tement = 3‚Äì6 photos typiquement),

g√©n√®re pour chaque groupe un brouillon d‚Äôannonce Vinted (Phase A), avec option d‚Äôencha√Æner la Phase B (publication) opt-in et rate-limit√©e.

üéØ Objectif technique

Impl√©mente un module Bulk robuste + endpoints :

Nouveaux endpoints (namespace /bulk)

POST /bulk/ingest/photos ‚Üí multipart (1..500 fichiers).
Retourne un catalogue provisoire : items[] = clusters {id, category, color, photos, score}.

POST /bulk/ingest/zip ‚Üí un seul ZIP ; d√©compresse en /tmp et r√©utilise la m√™me logique.

GET /bulk/status ‚Üí progr√®s (files_scanned, clusters, queue, errors).

POST /bulk/listings/plan ‚Üí applique des r√®gles de prix/titres et produit un plan JSON des annonces (sans toucher Vinted).

POST /bulk/listings/execute ‚Üí ex√©cute le plan : pour chaque cluster ‚Üí /vinted/listings/prepare (brouillon), et optionnellement /vinted/listings/publish pour les items publish=true (respecter rate limit 5/min + backoff).

Reconnaissance & regroupement

D√©duplication : imagehash (phash/ahash) + seuil (ex: distance ‚â§ 5) pour ignorer stricts doublons.

Embedding & clustering : calcule un embedding CLIP (lib: open-clip-torch) pour chaque photo ; regroupe par similarit√© (DBSCAN/Agglomerative) pour former un article.

Cat√©gorisation (zero-shot) : prompt CLIP sur un label set ‚Äúmode‚Äù (ex. ["t-shirt","hoodie","sweatshirt","joggers","jeans","pantalon","short","puffer jacket","veste","manteau","parka","windbreaker","chemise","polo","robe","jupe","casquette","bonnet","sneakers","chaussures","sac"]) et renvoie category + score.

Couleur dominante : K-means/Voronoi simple (3‚Äì5 clusters couleur) ‚Üí label (noir/blanc/gris/bleu/rouge/vert/jaune/beige/marron/rose/violet/orange).

R√®gles d‚Äôannonce (template)

Titre : "{Category} {Couleur} ({√âtat}) ‚Äì Taille {Size?}" (si taille inconnue ‚Üí omets).

Description (template Jinja-like) :

{Category} {Couleur}. Bon √©tat. Envoi rapide depuis Grenoble.
Photos r√©elles. Remise possible sur lot. #VintedBotStudio


Prix : soit par d√©faut (env DEFAULT_PRICE=20), soit map simple par category (env PRICE_RULES_JSON).

√âtat par d√©faut : ‚Äúbon‚Äù.

Brand : ‚ÄúUnknown‚Äù (laisse le champ modifiable ensuite).

Persistance

Sauvegarde le catalogue et le plan dans data/catalog.json et data/plan.json (overrides s√©curis√©s).

Journalise (sobre) les d√©cisions (cluster id ‚Üî fichiers, cat√©gorie/couleur/score).

üß∞ D√©livrables (√† produire dans ta r√©ponse)

Plan de conception (bref) : choix des libs, seuils, limites.

Changelist (fichiers cr√©√©s/modifi√©s) avec chemins pr√©cis.

Code complet des nouveaux fichiers + patchs n√©cessaires :

backend/core/vision.py :

chargement open-clip-torch, extraction embeddings, zero-shot, couleur dominante,

helpers de clustering (DBSCAN/Agglo), d√©duplication via imagehash.

backend/api/v1/routers/bulk.py :

routes /bulk/ingest/photos, /bulk/ingest/zip, /bulk/status, /bulk/listings/plan, /bulk/listings/execute,

utilisation d‚ÄôAPScheduler/BackgroundTasks pour traiter 147+ photos sans bloquer.

backend/schemas/bulk.py : mod√®les Pydantic (ClusterOut, PlanIn/Out, etc.).

M√†J backend/app.py : app.include_router(bulk_router).

M√†J backend/settings.py :

DEFAULT_PRICE=20
PRICE_RULES_JSON={"hoodie":25,"t-shirt":10,"jeans":25,"veste":35}
BULK_MAX_FILES=500
BULK_CLUSTER_EPS=0.24    # seuil similarit√© (cosine) pour DBSCAN, √† ajuster
BULK_MIN_SAMPLES=2


cURL tests pr√™ts √† copier :

ZIP ingest, status, plan (avec override prix/titres), execute (dry-run true ‚Üí puis r√©el opt-in).

Crit√®res d‚Äôacceptation : formats JSON attendus, d√©bit s√©curis√© (rate-limit), dry-run par d√©faut.

Notes perf & limites (RAM/CPU Replit ; fallback si GPU indispo ; pagination 147 photos).

S√©curit√© & conformit√© (obligatoire)

Aucun secret (cookie, UA, tokens) logu√© en clair.

Publication r√©elle uniquement si publish=true dans le plan ET dry_run:false ; sinon on reste en brouillon.

Respect du rate limit (5/min publish) + backoff (tenacity).

Si captcha/challenge d√©tect√© pendant publish ‚Üí needs_manual:true pour cet item, pas d‚Äôaction.

D√©pendances √† ajouter
uv add open-clip-torch torch torchvision scikit-learn numpy pillow python-multipart tenacity imagehash
python -m playwright install chromium

Contrats JSON attendus (exemples)
POST /bulk/ingest/zip  -> { "ok": true, "files": 147, "job_id": "..." }
GET  /bulk/status?job= -> { "ok": true, "progress": {"scanned":147,"clusters":38}, "clusters":[{ "id":"c1","photos":[...],"category":"hoodie","color":"noir","score":0.83 }] }
POST /bulk/listings/plan -> { "ok": true, "items":[ { "cluster_id":"c1","title":"Hoodie noir (bon)","price":25,"description":"...", "publish": false } ] }
POST /bulk/listings/execute -> { "ok": true, "results":[ { "cluster_id":"c1","prepare": {"ok": true, "confirm_token":"..."}, "publish": {"ok": true, "listing_url":"..."} } ] }

üß™ cURL (exemples rapides)
# 1) Ingest d‚Äôun ZIP de 147 photos
curl -X POST "$BASE_URL/bulk/ingest/zip" -F "file=@/path/photos_147.zip"

# 2) Suivre le job
curl "$BASE_URL/bulk/status?job=<JOB_ID>"

# 3) G√©n√©rer le plan (avec prix par d√©faut)
curl -X POST "$BASE_URL/bulk/listings/plan" -H "Content-Type: application/json" -d '{"defaults":{"price":25,"condition":"bon","publish":false}}'

# 4) Ex√©cuter le plan (brouillons uniquement)
curl -X POST "$BASE_URL/bulk/listings/execute" -H "Content-Type: application/json" -d '{"dry_run":true}'

# 5) Publication opt-in (seulement pour certains clusters)
curl -X POST "$BASE_URL/bulk/listings/execute" -H "Content-Type: application/json" -d '{
  "dry_run": false,
  "only": ["c3","c7","c12"],
  "set_publish_true": true
}'

‚úÖ Termine ta r√©ponse par :

‚Äú‚û°Ô∏è PROMPT √Ä COLLER DANS LOVABLE (front)‚Äù
Donne un bloc pr√™t-√†-copier qui :

ajoute une page /bulk (drag-n-drop ZIP + suivi de job + aper√ßu clusters),

affiche pour chaque cluster: vignettes, cat√©gorie/couleur/score, champs √©ditables (titre, prix, publish ‚úì),

permet de g√©n√©rer le plan puis ex√©cuter (dry-run par d√©faut, switch ‚Äúpublier r√©ellement‚Äù),

r√©utilise VITE_API_BASE_URL,

liste les fichiers/Composants (React + Tailwind + shadcn/ui) √† cr√©er (BulkPage, ClusterCard, PlanTable, apiClient.bulk),

rappelle les erreurs communes (413 upload, 401 non connect√©, needs_manual).

Important : garde le dry_run par d√©faut partout ; publication r√©elle opt-in + confirmation UI. Logs sobres, pas de secrets.