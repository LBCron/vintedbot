PROMPT BACKEND ‚Äî Ordre de mission ‚ÄúCr√©ation de post Vinted‚Äù

Contexte actuel (√† prendre en compte sans rien casser)

Stack : FastAPI (Py 3.11) + Uvicorn, port 5000, Replit Reserved VM.

Gestion paquets : uv.

URL publique (dev) : https://b3358a26-d290-4c55-82fc-cc0ad63fac5b-00-29ghky26cw3zi.janeway.replit.dev

Structure :

backend/
  app.py
  settings.py
  models.py
  routes/{health.py, ws.py}
  api/v1/routers/ingest.py        # /api/v1/ingest/upload (+ alias /ingest/upload)
  core/media.py
  jobs/                            # APScheduler
  data/{items.json, drafts.json}
  tests/test_ingest_upload.py


Endpoints d√©j√† op√©rationnels : /health, /ready, /stats, /api/v1/ingest/upload, alias /ingest/upload, /ws.

CORS ouvert (*) ; rate limit upload OK ; MOCK_MODE possible.

Objectif business : publier sur Vinted en 2 temps (draft puis publication), avec auth manuelle via header Cookie + User-Agent, aucun bypass captcha/anti-bot, et uploads de photos pilot√©s depuis notre front (Lovable).

üéØ Ce que je veux faire MAINTENANT

Connexion Vinted (d√©j√† pos√©e si tu l‚Äôas) : endpoints pour enregistrer cookie/user-agent, v√©rifier l‚Äôauth.

Phase A ‚Äî Pr√©parer un post (draft / pr√©-publication)

Aller sur /items/new, uploader des photos, remplir titre, prix, description, marque, taille, √©tat (+ champs simples si pr√©sents).

S‚Äôarr√™ter avant la confirmation ‚ÄúPublier‚Äù.

Retourner un confirm_token (sign√©/TTL), un preview_url, et si possible un screenshot base64 de l‚Äô√©cran rempli (optionnel).

dry_run par d√©faut.

Phase B ‚Äî Publier (opt-in)

Endpoint s√©par√© qui prend confirm_token + dry_run (true par d√©faut).

Si dry_run:false ET qu‚Äôaucun captcha/challenge n‚Äôest d√©tect√©, cliquer ‚ÄúPublier‚Äù et renvoyer { listing_id, listing_url }.

Si challenge/captcha d√©tect√© ‚Üí ne rien publier, renvoyer { needs_manual:true, reason:"captcha_or_verification" }.

Uploads photos : route d√©di√©e en multipart/form-data, r√©utilisable par la phase A.

S√©curit√© : jamais loguer le cookie en clair ; stocker la session chiffr√©e (Fernet).

Rate limit publication (ex. 5/min global).

Idempotency optionnelle via header Idempotency-Key.

üß© Contraintes & r√®gles

Aucun bypass des m√©canismes Vinted (captcha/challenges). En cas de doute, stopper et retourner needs_manual:true.

Pacing humain (petits d√©lais al√©atoires).

Compatibilit√© Replit (Chromium headless --no-sandbox).

Respect de la structure du repo ; ne pas casser les endpoints existants.

CORS conserv√©.

Variables d‚Äôenv √† utiliser :

SECRET_KEY (Fernet), SESSION_STORE_PATH="data/session.enc", MOCK_MODE (bool).

Les routes doivent vivre sous le namespace /vinted/* (p.ex. backend/api/v1/routers/vinted.py).

üõ†Ô∏è D√©livrables attendus (ta r√©ponse doit contenir)

Plan technique raisonn√© (bref) : choix, s√©lecteurs tol√©rants, d√©tection challenge, tokens/TTL, limites.

Changelist : fichiers cr√©√©s/modifi√©s (chemins exacts).

Code complet √† ins√©rer (nouveaux fichiers) + patchs (extraits diff) pour fichiers existants :

backend/api/v1/routers/vinted.py :

POST /vinted/auth/session (enregistrer cookie/UA, valider)

GET /vinted/auth/check

POST /vinted/photos/upload

NOUVEAU POST /vinted/listings/prepare

NOUVEAU POST /vinted/listings/publish

backend/core/session.py (Vault chiffr√©) ‚Äî si absent, le cr√©er

backend/core/vinted_client.py : helpers Playwright (context, upload, fill form, detect captcha, publish)

Ajustement backend/app.py pour monter le router

backend/settings.py : param√®tres manquants

Tests manuels (cURL) pr√™ts √† copier :

Injecter session (/vinted/auth/session)

Check (/vinted/auth/check)

Upload photo (/vinted/photos/upload)

Pr√©parer (/vinted/listings/prepare)

Publier (dry-run) puis Publier (r√©el, opt-in)

Crit√®res d‚Äôacceptation clairs (r√©ponses JSON attendues, branches d‚Äô√©chec).

Consignes d‚Äôobservabilit√© : logs sobres, pas de secrets, erreurs HTTP explicites (400/401/409/429/500).

‚úÖ Sch√©mas JSON (contrat API √† respecter)
POST /vinted/auth/session
req:  { "cookie": "<header Cookie complet>", "user_agent": "<UA>", "expires_at": null }
res:  { "ok": true, "persisted": true, "username": "<optionnel>" }

GET /vinted/auth/check
res:  { "authenticated": true|false, "username": "‚Ä¶", "user_id": "‚Ä¶" }

POST /vinted/photos/upload (multipart)
res:  { "ok": true, "photo": { "temp_id": "‚Ä¶", "url": "‚Ä¶" } }

POST /vinted/listings/prepare
req:  {
  "title":"‚Ä¶", "price": 35, "description":"‚Ä¶",
  "brand":"‚Ä¶","size":"‚Ä¶","condition":"‚Ä¶",
  "color":"‚Ä¶","category_hint":"‚Ä¶",
  "photos":[], "dry_run": true
}
res:  {
  "ok": true, "dry_run": true,
  "confirm_token": "‚Ä¶", "preview_url":"https://www.vinted.fr/items/new",
  "screenshot_b64":"‚Ä¶?" , "draft_context": {‚Ä¶}
}

POST /vinted/listings/publish
req:  { "confirm_token": "‚Ä¶", "dry_run": true }
res (dry_run): { "ok": true, "dry_run": true }
res (r√©el):    { "ok": true, "dry_run": false, "listing_id": "‚Ä¶", "listing_url": "‚Ä¶" }
res (challenge): { "ok": true, "dry_run": false, "needs_manual": true, "reason": "captcha_or_verification" }

üß™ cURL de test (remplacer <BASE>)

BASE=https://b3358a26-d290-4c55-82fc-cc0ad63fac5b-00-29ghky26cw3zi.janeway.replit.dev

Session

curl -sS -X POST "<BASE>/vinted/auth/session" -H "Content-Type: application/json" --data-binary @- <<'JSON'
{"cookie":"<HEADER COOKIE COMPLET>","user_agent":"<UA>","expires_at":null}
JSON


Check

curl -sS "<BASE>/vinted/auth/check"


Upload photo

curl -sS -X POST "<BASE>/vinted/photos/upload" -F "file=@/chemin/vers/photo.jpg"


Prepare

curl -sS -X POST "<BASE>/vinted/listings/prepare" -H "Content-Type: application/json" -d '{
  "title":"Hoodie Diesel","price":35,"description":"Bon √©tat",
  "brand":"Diesel","size":"L","condition":"bon",
  "color":"noir","category_hint":"Homme > Sweats",
  "photos": [], "dry_run": true
}'


Publish (dry-run)

curl -sS -X POST "<BASE>/vinted/listings/publish" -H "Content-Type: application/json" -d '{"confirm_token":"<COPIE ICI>","dry_run":true}'


Publish (r√©el, opt-in)

curl -sS -X POST "<BASE>/vinted/listings/publish" -H "Content-Type: application/json" -H "Idempotency-Key: abc123" -d '{"confirm_token":"<COPIE ICI>","dry_run":false}'

üì¶ Format attendu de ta r√©ponse (IMPORTANT)

R√©ponds dans cet ordre :

Plan technique (bref, 5‚Äì10 lignes max).

Changelist (fichiers cr√©√©s/modifi√©s).

Code (nouveaux fichiers complets + patchs cibl√©s).

Commandes de test (cURL).

Checklist d‚Äôacceptation.

Observations / limites / next steps.

‚û°Ô∏è PROMPT √Ä COLLER DANS LOVABLE

Fournis, en bloc pr√™t √† copier, le prompt front pour Lovable (Next/Vite) afin :

d‚Äôajouter/mettre √† jour les pages /settings, /upload, /listings

de connecter VITE_API_BASE_URL

d‚Äôappeler : POST /vinted/auth/session, GET /vinted/auth/check, POST /vinted/photos/upload, POST /vinted/listings/prepare, POST /vinted/listings/publish

d‚Äôafficher l‚Äô√©tat de connexion, la liste des photos upload√©es, un formulaire de draft, un bouton ‚ÄúPublier (opt-in)‚Äù avec dry_run par d√©faut, et la gestion des r√©ponses (needs_manual, listing_url, etc.).

Ce bloc doit √™tre clair, concis, et copiable tel quel dans la section Knowledge ‚Üí Docs de Lovable ou dans un message √† l‚ÄôIA de Lovable.

Merci de penser avant d‚Äô√©crire : propose des s√©lecteurs r√©silients, g√®re les erreurs proprement, et n‚Äôins√®re aucune donn√©e sensible dans les logs.