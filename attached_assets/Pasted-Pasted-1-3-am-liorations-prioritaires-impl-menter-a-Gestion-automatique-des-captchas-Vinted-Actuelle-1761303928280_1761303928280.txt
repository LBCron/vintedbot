Pasted-1-3-am-liorations-prioritaires-impl-menter-a-Gestion-automatique-des-captchas-Vinted-Actuellem-1761303668393_1761303668394.txt
1. 3 améliorations prioritaires à implémenter
a. Gestion automatique des captchas Vinted
Actuellement, les captchas bloquent le process sans solution automatisée.
Priorité : intégrer un solver externe (2Captcha) pour garantir la publication en continu, surtout en scaling.
b. Retry logic robuste sur la publication (exponential backoff)
Si une publication échoue (erreur réseau, timeout, quota, captcha), il n’y a pas de retry automatique.
Priorité : ajouter un système de retry avec backoff exponentiel pour fiabiliser le taux de succès sans surcharger l’API Vinted.
c. Multi-utilisateurs sécurisé (table users + JWT)
L’API est single-user, ce qui limite la scalabilité et la gestion des comptes.
Priorité : ajouter une table users, gestion des sessions par utilisateur, et JWT pour l’authentification.
2. Résolution automatique des captchas Vinted avec 2Captcha
Principe :
Quand Playwright détecte un captcha (ex : hCaptcha, reCAPTCHA), extraire le sitekey et l’URL de la page cible.
Envoyer une requête à l’API 2Captcha avec :
method: hcaptcha ou recaptcha
sitekey: récupéré depuis la page
pageurl: URL de la page Vinted concernée
Poller l’API 2Captcha jusqu’à obtenir la solution (requestId, puis GET sur /res.php?key=...&action=get&id=...)
Injecter le token de réponse dans le DOM via Playwright (document.querySelector('textarea[name="h-captcha-response"]').value = ...)
Soumettre le formulaire ou simuler le clic de validation.
Implémentation (pseudo-code) :
python
Copier le code
# 1. Détection du captcha dans Playwright
if captcha_detected:
    sitekey = await page.evaluate('document.querySelector("[data-sitekey]").getAttribute("data-sitekey")')
    pageurl = page.url

    # 2. Création de la tâche 2Captcha
    resp = requests.post("http://2captcha.com/in.php", data={
        "key": "VOTRE_2CAPTCHA_KEY",
        "method": "hcaptcha",
        "sitekey": sitekey,
        "pageurl": pageurl,
        "json": 1
    })
    request_id = resp.json()["request"]

    # 3. Polling jusqu’à solution
    for _ in range(20):
        sleep(5)
        r = requests.get(f"http://2captcha.com/res.php?key=VOTRE_2CAPTCHA_KEY&action=get&id={request_id}&json=1")
        if r.json()["status"] == 1:
            solution = r.json()["request"]
            break

    # 4. Injection de la solution dans la page
    await page.evaluate(f'document.querySelector("[name=\'h-captcha-response\']").value = "{solution}"')
    await page.click("#submit-captcha")
Gérer les erreurs, timeouts, et quotas 2Captcha.
Journaliser les tentatives et résultats pour audit.
3. Ajouter un système de retry avec exponential backoff
Librairie recommandée : tenacity (Python)
Permet de décorer les fonctions critiques avec une logique de retry automatique.
Exemple d’intégration pour la publication :
python
Copier le code
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type

@retry(
    stop=stop_after_attempt(3),  # max 3 tentatives
    wait=wait_exponential(multiplier=1, min=5, max=60),  # backoff exponentiel
    retry=retry_if_exception_type((NetworkError, TimeoutError, CaptchaError))
)
async def publish_with_retry(draft_id):
    return await publish_listing(draft_id)
Loguer chaque tentative et l’erreur rencontrée.
Option : stocker les tentatives échouées dans une dead-letter queue pour analyse ou intervention manuelle.
4. Métriques Prometheus recommandées pour l’observabilité
a. Publication
vintedbot_publish_total{status="success|fail|captcha|timeout"}
vintedbot_publish_duration_seconds (histogramme)
vintedbot_publish_retry_count
b. Analyse IA
vintedbot_photo_analyze_total
vintedbot_photo_analyze_duration_seconds
c. Files d’attente
vintedbot_publish_queue_size
vintedbot_bulk_job_active_total
d. Captchas
vintedbot_captcha_detected_total
vintedbot_captcha_solved_total
vintedbot_captcha_failure_total
e. Utilisateurs
vintedbot_active_users
vintedbot_publish_per_user_total
f. Système
Uptime, erreurs critiques, usage CPU/mémoire (via exporter standard)
Exemple de code (FastAPI + prometheus_client) :
python
Copier le code
from prometheus_client import Counter, Histogram

publish_total = Counter("vintedbot_publish_total", "Total publications", ["status"])
publish_duration = Histogram("vintedbot_publish_duration_seconds", "Durée publication")
publish_queue_size = Gauge("vintedbot_publish_queue_size", "Taille de la file de publication")
Exposer /metrics sur une route dédiée.
5. Migration vers un système multi-utilisateurs (table users + JWT)
Étapes clés :
Table users
sql
Copier le code
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    username TEXT UNIQUE,
    password_hash TEXT,
    email TEXT,
    vinted_session_id INTEGER,
    openai_api_key TEXT ENCRYPTED,
    quota_limit INTEGER,
    created_at TEXT
);
Gestion des sessions par utilisateur
Lier chaque session Vinted à un user (user_id).
Adapter les endpoints pour prendre en compte l’uti...